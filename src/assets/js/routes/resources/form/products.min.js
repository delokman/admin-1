!function(){"use strict";var at=window.tabId,nt=window.Tabs[at],rt=window.lang,ot=nt.commit,st=function(){return nt.data},ct=window.i18n;nt.continue=function(){var t=nt.$form,j=randomObjectId(),D=0,a=$("#t"+at+"-enDate"),n=$("#t"+at+"-startDate"),w={size:{title:ct({en_us:"Size",pt_br:"Tamanho"})},material:{title:"Material"},pattern:{title:ct({en_us:"Pattern",pt_br:"Estampa"})},colors:{title:ct({en_us:"Primary color",pt_br:"Cor primária"})},"colors.2":{title:ct({en_us:"Secondary color",pt_br:"Cor secundária"})}},_={};$.getJSON("json/misc/variations_grids.json",function(t){for(var i in t){var e=t[i];e&&(w.hasOwnProperty(i)&&e.options?w[i].options=ct(e.options):w[i]=ct(e))}}).always(function(){window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,i){if(!t)for(var e=0;e<i.result.length;e++){var a=i.result[e],n=normalizeString(a.title);for(var r in w)w.hasOwnProperty(r)&&r!==a.grid_id&&normalizeString(w[r].title)===n&&delete w[r];var o=w[a.grid_id];o?(o.title=a.title,a.options&&(o.options=o.options.concat(o.options,a.options))):w[a.grid_id]=a}setTimeout(function(){var t,i=st(),e=i.specifications;if(e)for(t in e){var a=e[t];if(Array.isArray(a)){var n=et(t);n&&n(a[0].text)}}var s=i.variations;if(Array.isArray(s)&&s.length){var r=function(a,n){setTimeout(function(){for(var t=0;t<s.length;t++){var i=s[t].specifications[n];if(Array.isArray(i))for(var e=0;e<i.length;e++)a(i[e])}},600)};if(e=s[0].specifications)for(t in e){var o;if(e.hasOwnProperty(t))o=w.hasOwnProperty(t)?w[t]:{title:t},r(l(o),t)}setTimeout(function(){S(!0),setTimeout(function(){for(var t=z.find('input[type="checkbox"]'),i=0;i<s.length;i++){var e="",a=s[i].specifications;for(var n in a){var r=a[n];if(Array.isArray(r))for(var o=0;o<r.length;o++)e+=","+r[o].value}t.filter(function(){return $(this).data("value")===e}).data("checked",!0)}t.filter(function(){return!$(this).data("checked")}).data("skip-data",!0).prop("checked",!1).trigger("change")},200)},800)}},100)})});var r=function(){var t=[];for(var i in w)w.hasOwnProperty(i)&&t.push(w[i].title);return t},k=function(t){var i=[];if(w[t]){var e=w[t].options;if(void 0!==e)for(var a=0;a<e.length;a++)i.push(e[a].text)}return i};nt.saveCallback=function(){var t=st();if(t){var i,e=[],a=function(t){if(t.specifications)for(i in t.specifications)t.specifications.hasOwnProperty(i)&&-1===e.indexOf(i)&&e.push(i)};a(t),t.variations&&t.variations.forEach(function(t){a(t)}),window.callApi("grids.json?fields=grid_id","GET",function(t,n){t||e.forEach(function(t){for(var i=0;i<n.result.length;i++)if(n.result[i].grid_id===t)return;var e;if(w.hasOwnProperty(t)&&w[t].title)e=w[t].title;else{if(!it.hasOwnProperty(t))return;e=it[t]}var a={grid_id:t,title:e};window.callApi("grids.json","POST",null,a,!0)})})}};var y=function(t){var i;for(var e in w)if(w.hasOwnProperty(e)&&normalizeString(w[e].title)===t){t=e,i=!0;break}if(!i)switch(t){case"cores":case"cor":case"color":t="colors";break;case"tamanhos":case"tamanho":case"sizes":t="size"}return t},o=function(t,i,e){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:i,source:e})},s=$("#t"+at+"-grids-list"),c='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+ct({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="M"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(s[0],{handle:".i-drag",onUpdate:function(t){var i=Object.keys(_),e=i.splice(t.oldIndex,1)[0];e&&i.splice(t.newIndex,0,e);for(var a={},n=0;n<i.length;n++){var r=i[n];a[r]=_[r]}_=a,S()}});var x=0,l=function(t){var i=s.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(!i.length){var l=$("<li />",{html:c});s.append(l);var d,f,u,v=l.find('input[name="grid"]'),p=l.find(".option-block"),h=p.find('input[name="option"]'),e=!0,g=!0,m=[];t&&v.val(t.title);var b=function(t){var i;i=t?Object.assign({},t):null,O(l,h,d,f,i)};return v.change(function(){if(!u){u=!0;var t=$(this).val().trim();if(""!==t){var i;if(f&&(i=f),i!==(f=y(normalizeString(t)))){if((m=k(f)).length&&h.attr("placeholder",m[0]),_.hasOwnProperty(f)){for(var e=2;_.hasOwnProperty(f+"."+e);)e++;f+="."+e}i?(_[f]=_[i],delete _[i]):_[f]=[],w.hasOwnProperty(f)||(w[f]={title:t}),$(this).data("grid-id",f)}if(0===f.indexOf("colors")){if(!d){var r,o=w.colors.options;d=$("<input />",{class:"form-control",placeholder:"#ffffff",type:"text",name:"rgb",keydown:function(t){switch(t.which){case 9:setTimeout(function(){v.focus()},100);break;case 13:$(this).trigger("change")}},change:function(){var t=$(this).val().trim().toLowerCase();if(/^#[a-f0-9]{6}$/.test(t)){if(o)for(var i=0;i<o.length;i++){var e=o[i],a=e.colors;if(a&&a[0]===t)return h.typeahead("val",e.text),r.slideUp(),void b()}var n=function(){h.focus()};r.is(":visible")?setTimeout(n,100):r.slideDown(400,n)}}}),p.prepend(d),(r=d.nextAll()).addClass("mt-10").hide();var a={theme:"bootstrap",position:"top left",swatches:[]};if(o)for(var n=0;n<o.length;n++){var s=o[n].colors;s&&s.length&&a.swatches.push(s[0])}d.minicolors(a);var c=d.nextAll(".minicolors-panel");c.addClass("swatches-only").css("top",-(c.height()+8)+"px")}g&&d.focus()}else d&&(d.minicolors("destroy").remove(),d=null),g&&h.focus()}else h.typeahead("val",""),1<x&&P(l,f);g=!0,setTimeout(function(){u=!1},100)}}).blur(function(){u||setTimeout(function(){v.trigger("change")},100)}).keyup(function(){""!==v.val()?e&&(p.fadeIn(),e=!1,1===x&&$("#t"+at+"-add-option-header").fadeIn()):e||(p.fadeOut(),e=!0,1===x&&$("#t"+at+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:v.trigger("blur")}}),h.keydown(function(t){switch(t.which){case 9:setTimeout(function(){v.focus()},100);break;case 13:b()}}),o(v,"grids",substringMatcher(r())),o(h,"options",substringMatcher(function(){return m})),l.find(".remove-grid").click(function(){P(l,f)}),l.find(".add-option").click(function(){b()}),1===++x&&$("#t"+at+"-grids-list-header").slideDown(),l.slideDown(400,function(){t?(g=!1,v.trigger("keyup").trigger("change")):v.focus(),setTimeout(function(){window.Sortable.create(l.find(".badges-list")[0],{onUpdate:function(t){var i=_[f],e=i.splice(t.oldIndex,1)[0];e&&i.splice(t.newIndex,0,e),S()}})},200)}),b}i.focus()},v=function(t,i){var e;if(w[t]){var a=w[t].options;if(a)for(var n=0;n<a.length;n++)if(i===normalizeString(a[n].text)){e=a[n];break}}return e},O=function(i,t,e,a,n){var r,o,s,c,l=function(){var t;return n&&(o=n.option_id,t=n.value||n.option_id),function(t,i,e,a,n,r){for(var o=_[e],s=0;s<o.length;s++)if(a===o[s].option_id)return!1;var c={option_id:a,text:r};i&&(n=i.minicolors("value")),n&&(c.value=n),o.push(c);var l=$("<li />",{html:'<span class="i-drag white"></span>'+r+'<i class="fa fa-times"></i>'});return t.find(".badges-list").append(l),l.find(".fa-times").click(function(){if(l.remove(),a){if(1<o.length){for(var t=0;t<o.length;t++)if(o[t].option_id===a){o.splice(t,1);break}}else _[e]=[];S()}}),!0}(i,e,a,o,t,r)};if(n)c=!0,r=n.text,n.option_id||(n.option_id=n.value);else{if(r=t.val().trim(),t.typeahead("val","").attr("placeholder",r).focus(),!a)return;n=v(a,normalizeString(r))}if(n)s=l();else for(var d=r.split(/[,;/\\|.]+/g),f=0;f<d.length;f++)if(""!==(r=d[f].trim())){o=normalizeString(r),n=v(a,o);var u=l();u&&!s&&(s=u)}s&&!c&&S()},z=$("#t"+at+"-variations-list"),d=function(t){return z.children(":not(.disabled)").index(t)},C=function(n,r){return function(){var t,i,e=st();if($(this).data("skip-data")&&(t=!0,$(this).removeData("skip-data")),$(this).is(":checked")){if(n.removeClass("disabled"),!t){i=d(n);var a=JSON.parse($(this).data("variation"));e.variations?e.variations.splice(i,0,a):e.variations=[a]}r.removeAttr("disabled")}else t?$(this).data("variation",$(this).data("original-variation")):(i=d(n),$(this).data("variation",JSON.stringify(e.variations[i])),1<e.variations.length?e.variations.splice(i,1):delete e.variations),n.addClass("disabled"),r.attr("disabled",!0);t||ot(e,!0)}},U=function(t){return function(){B(d(t))}},S=function(I){var T,A={};for(T in _){var t=_[T];t&&t.length&&(A[T]=t)}z.slideUp(400,function(){var t,i,e,a;$(this).html(""),t=I?{}:st();var n=getCombinations(A);if(0<n.length){var r=[];for(i=0;i<n.length;i++){var o=n[i],s="",c=new RegExp("^"+N+"(\\s\\/\\s.*)$"),l=N,d="",f={};for(T in o)if(o.hasOwnProperty(T)){var u=o[T].text;l+=" / "+u,s+="<span>"+u+"</span>";var v={text:u},p=o[T].value||o[T].option_id;d+=","+p,p&&(v.value=p),T=T.replace(/\..*/,""),f.hasOwnProperty(T)?f[T].push(v):f[T]=[v]}var h=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});h.find("label").html(s);var g=h.find("button");g.click(U(h));var m=h.find('input[type="checkbox"]').data("value",d).change(C(h,g));z.append(h),h.slideDown();var b={};if(t.variations){var w=r.length,_={matches:0,index:null};for(e=0;e<t.variations.length;e++){var k=t.variations[e].specifications,y=0;for(var x in k)if(k.hasOwnProperty(x)&&f.hasOwnProperty(x)){var O=!1;if((a=k[x].length)===f[x].length){for(var S=0;S<a;S++)if(k[x][S].text!==f[x][S].text){O=!0;break}}else O=!0;if(O){y=0;break}y++}if(!(y<_.matches)){if(y===_.matches){if(e!==w)continue;_.sameIndex=!0}if(_.index=e,y===Object.keys(f).length&&y===Object.keys(k).length){_.sameSpecs=!0;break}}}null!==_.index&&(b=t.variations[_.index],_.sameSpecs||(delete b._id,delete b.specifications,_.sameIndex||delete b.sku))}b._id||(b._id=objectIdPad(j,""+D),D++,b.specifications=f),b.name&&!c.test(b.name)||(b.name=l),r.push(b),m.data("original-variation",JSON.stringify(b))}if(!I){for(""===M&&"function"==typeof E&&E(),a=r.length,i=0;i<a;i++)if(!r[i].sku){for(var P=null;!P;)for(P=M+"-"+randomInt(100,999)+"-"+(i+1),e=0;e<a.length;e++)if(P===r[e].sku){P=null;break}r[i].sku=P}t.variations=r}}else delete t.variations;$(this).slideDown(),I||ot(t,!0)})};$("#t"+at+"-add-grid").click(function(){l()});var P=function(t,i){t.slideUp(400,function(){$(this).remove()}),0===--x&&$("#t"+at+"-grids-list-header, #t"+at+"-add-option-header").slideUp(),delete _[i],S()},i=function(t){var i,e=st(),a=e[t]||"",n=e.variations;if(i="name"===t?N:M,n){for(var r=new RegExp("^"+i),o=0;o<n.length;o++){var s=n[o];"string"==typeof s[t]&&(s[t]=s[t].replace(r,a))}ot(e,!0)}"name"===t?N=a:M=a},M=st().sku||"",f=t.find('input[name="sku"]');f.click(function(){$(this).select()}).change(function(){i("sku")});var g=function(){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e=0;e<3;e++)t+=i.charAt(Math.floor(Math.random()*i.length));t+=randomInt(1e3,9999),f.val(t).trigger("change"),u(t,function(){g()})};$("#t"+at+"-random-sku").click(g);var E,u=function(t,n){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,i){if(!t){var e=i.result,a=e.length;a&&(1<a||e[0]._id!==nt.resourceId)&&("function"==typeof n?n():app.toast(ct({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"})))}})};nt.resourceId?""!==M&&u(M):(E=function(){""===M&&g(),t.off("change",'input[name="name"]',E),E=null},t.on("change",'input[name="name"]',E)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var n=$(this).siblings(".dropdown-menu");if(n.length){var r,o=$(this);n.find(".bs-searchbox input").keydown(function(){var a=$(this);r&&clearTimeout(r),r=setTimeout(function(){r=null;var t=n.find(".dropdown-menu > .no-results");if(t.length){var i=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+ct({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(e,i){var a=function(t){return JSON.stringify({_id:t,name:i})},n=$("<option />",{text:i,selected:!0,value:a(objectIdPad(j,""+D))});D++,e.append(n).selectpicker("refresh").trigger("change");var t=e.attr("name");window.callApi(t+".json","POST",function(t,i){t||(n.val(a(i._id)),e.trigger("change"))},{name:i})}(o,a.val())}}),e=$("<div />",{html:i});t.html(e),e.slideDown(120)}},300)})}})},400);var N=st().name||"",e=ct({en_us:"New product",pt_br:"Novo produto"}),p=st();if(p.price_effective_date){if(p.price_effective_date.end){var h=p.price_effective_date.end.substring(0,10).split("-"),m=h[0],b=h[1],I=h[2];"pt_br"===rt?a.val(I+"/"+b+"/"+m):a.val(h)}if(p.price_effective_date.start){var T=p.price_effective_date.start.substring(0,10).split("-"),A=T[0],L=T[1],J=T[2];"pt_br"===rt?n.val(J+"/"+L+"/"+A):n.val(T)}}n.change(function(){var t=st();if(t.hasOwnProperty("price_effective_date")||(t.price_effective_date={}),n.val()){var i=n.val().split(/(\d{2})\/(\d{2})\/(\d{4})/).filter(String),e=new Date(parseInt(i[2]),parseInt(i[1])-1,parseInt(i[0])).toISOString();t.price_effective_date.start=e}else delete t.price_effective_date.start;ot(t,!0)}),a.change(function(){var t=st();if(t.hasOwnProperty("price_effective_date")||(t.price_effective_date={}),a.val()){var i=a.val().split(/(\d{2})\/(\d{2})\/(\d{4})/).filter(String),e=new Date(parseInt(i[2]),parseInt(i[1])-1,parseInt(i[0])).toISOString();t.price_effective_date.end=e}else delete t.price_effective_date.end;ot(t,!0)});var R=t.find('input[name="name"]');R.attr("placeholder",ct({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).click(function(){$(this).val()===e&&$(this).val("").trigger("change")}).change(function(){i("name")}),t.find('input[name="variations.name"]').attr("placeholder",ct({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),nt.formSetup();var G=0,V=t.children("#t"+at+"-product-fields"),K=t.children("#t"+at+"-variation-fields");$("#t"+at+"-back-to-product").click(function(){K.slideUp(400,function(){V.slideDown()})});var B=function(l){var d=st(),f=d.variations;if(f&&0<=l&&f.length>l){var u,v;d.name||R.val(e).trigger("change"),d.sku||g(),G=l;var t=[];for(v=0;v<f.length;v++)v!==l&&(u=f[v]).sku&&4<Object.keys(u).length&&t.push(u.sku);if(t.length){var i=[];for(v=0;v<t.length;v++)i.push($("<a />",{class:"dropdown-item",text:t[v],href:"javascript:;",click:function(t){return function(){Y(t)}}(v)}));X.html(i),W.show()}else W.hide();var p=(u=f[l]).specifications,h=K;V.slideUp(400,function(){var t="";for(var i in p){var e=p[i];if(e){for(t+='<h4><small class="subtitle m-0">'+w[i].title+"</small>",v=0;v<e.length;v++)t+=" <small>·</small> "+e[v].text;t+="</h4>"}}h.find("#t"+at+"-variation-specs").html(t),l<f.length-1?H.removeAttr("disabled"):H.attr("disabled",!0),0<l?Q.removeAttr("disabled"):Q.attr("disabled",!0);var a=d.pictures;if(a&&a.length){var n=[];for(v=0;v<a.length;v++){var r,o=a[v];r=o.hasOwnProperty("normal")?o.normal.url:o.zoom.url;var s=o._id,c={html:'<img src="'+r+'">',click:function(t){return function(){u.picture_id=t,ot(st(),!0),$(this).addClass("selected").siblings(".selected").removeClass("selected")}}(s)};u.picture_id===s&&(c.class="selected"),n.push($("<span />",c))}Z.show().find(".images-list").html(n)}else Z.hide();h.find("input,select").data("object-id",u._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(h,u,"variations."),h.slideDown()})}},F=function(t){K.slideUp(400,function(){B(G+t)})},H=K.find("#t"+at+"-next-variation"),Q=K.find("#t"+at+"-prev-variation");H.click(function(){F(1)}),Q.click(function(){F(-1)});var W=K.find("#t"+at+"-copy-variation"),X=W.children("div"),Y=function(t){var i=st(),e=i.variations;if(e){var a=e[t],n=e[G];if(a&&n){for(var r in a)if(a.hasOwnProperty(r))switch(r){case"_id":case"sku":case"specifications":case"name":break;default:n[r]=a[r]}ot(i,!0),setupInputValues(K,i)}}};K.find('input[name="variations.name"]').focus(function(){""===$(this).val()&&$(this).val(cutString(N,100)).select()}),K.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(M)?$(this).selectRange(M.length,t.length):$(this).select()});var Z=K.find("#t"+at+"-variation-image"),q=$("#t"+at+"-spec-name"),tt=$("#t"+at+"-specs-list");o(q,"specs",substringMatcher(r()));var it={},et=function(t){if(t||(t=q.val().trim()),""===t)q.focus();else{q.typeahead("val","");var l=y(normalizeString(t));w[l]&&(t=w[l].title),it[l]=t;var a=tt.find("input").filter(function(){return $(this).data("grid")===l});if(a.length)return void a.focus();a=$("<input>",{class:"form-control","data-grid":l,type:"text"});var i=$("<a>",{class:"p-2 text-danger",href:"javascript:;",html:'<i class="fa fa-ban"></i>'}),n=$("<div>",{class:"col-6 hidden",html:$("<div>",{class:"form-group",html:[i,"<label>"+t+"</label>",a]})});tt.append(n),n.slideDown(),o(a,"features",substringMatcher(k(l))),a.focus(),a.change(function(){var t=$(this).val().trim();if(""!==t){var i;$(this).data("skip-data")&&(i=!0,$(this).removeData("skip-data"));var e=normalizeString(t),a=v(l,e);if(a?e="colors"!==l?a.option_id:a.colors[0]:"colors"===l&&(e=null),!i){var n={text:t};e&&(n.value=e);var r=st();r.hasOwnProperty("specifications")||(r.specifications={});var o=r.specifications;if(o[l]){var s=$(this).data("spec-data");if(s)for(var c=0;c<o[l].length;c++)o[l][c].text===s&&(o[l][c]=n);else o[l].push(n)}else o[l]=[n];ot(r,!0)}$(this).data("spec-data",t)}}),i.click(function(){var i=a.data("spec-data");if(i){var t=st(),e=t.specifications;e&&e[l]&&(e[l]=$.grep(e[l],function(t){return t.text!==i}),e[l].length||delete e[l],ot(t,!0))}n.slideUp(400,function(){$(this).remove()})})}return function(t){a.typeahead("val",t).data("skip-data",!0).trigger("change")}};$("#t"+at+"-add-spec").click(function(){et()}),q.keydown(function(t){switch(t.which){case 13:et(),t.preventDefault()}})}}();