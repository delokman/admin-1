!function(){"use strict";var g=window.lang,y=window.i18n,w=window.tabId,e=window.Tabs[w],x=e.commit,k=function(){return e.data},t=function(){var t=k(),c=$("#t"+w+"-order-base"),e=c.find("#t"+w+"-order-amount"),n=e.find('input[name="amount.total"]');e.find('input:not([name="amount.total"])').change(function(){setTimeout(function(){var e=k().amount,t=(e.subtotal||0)+(e.freight||0)-(e.discount||0);e.tax&&(t+=e.tax),e.extra&&(t+=e.extra),n.val(formatMoney(0<=t?t:0)).trigger("change")},150)});var a,m,i=e.find("#t"+w+"-extra-amount"),o=function(){i.children("div").slideToggle()};i.children("a").click(o),t.amount&&(t.amount.tax||t.amount.extra)&&o(),setTimeout(function(){if(a=c.find("#t"+w+"-order-buyers"),m=a.find("#t"+w+"-buyer-info"),t.buyers)for(var e=0;e<t.buyers.length;e++)r(t.buyers[e])},200);var r=function(e){var t,a=e._id,n="",i=e.main_email;if(i&&(n+='<a href="mailto:'+i+'" target="_blank">'+i+"</a>"),e.name?(t=e.name.given_name,e.name.middle_name&&(t+=" "+e.name.middle_name),e.name.family_name&&(t+=" "+e.name.family_name),e.display_name&&(t+=" ("+e.display_name+")")):e.display_name&&(t=e.display_name),t&&(n+="<br>"+t),e.phones){e.phones.length&&(n+="<br>");for(var o=0;o<e.phones.length;o++){0<o&&(n+=" / ");var r=formatPhone(e.phones[o]);n+='<a class="text-muted" href="tel:'+r.replace(/\D/g,"")+'" target="_blank">'+r+"</a>"}}var s=$("<a>",{href:"#/resources/customers/"+a,html:'<i class="fa fa-pencil"></i> '+y({en_us:"edit registration",pt_br:"editar cadastro"})}),d=$("<i>",{class:"p-10 remove fa fa-trash"}).click(function(){for(var e=k(),t=e.buyers,n=0;n<t.length;n++){if(t[n]._id===a){t.splice(n,1),x(e,!0);break}}l.slideUp(300,function(){$(this).remove()})}),l=$("<div>",{class:"hidden mb-3 nested-block",html:[d,"<div>"+n+"</div>",s]});m.append(l),l.slideDown()},s=c.find("#t"+w+"-new-buyer"),d=s.find("input"),l=function(){s.addClass("ajax");var e="customers.json?main_email="+encodeURIComponent(d.val().trim());e+="&fields=_id,main_email,name,display_name,phones",window.callApi(e,"GET",function(e,t){if(s.removeClass("ajax"),!e){var n=t.result[0];if(n){for(var a=k(),i=a.buyers,o=0;o<i.length;o++)if(i[o]._id===n._id)return void app.toast(y({en_us:"This customer has already been added",pt_br:"Este cliente jÃ¡ foi adicionado"}));i.push(n),x(a,!0),r(n)}else app.toast(y({en_us:"No customers found with this email",pt_br:"Nenhum cliente encontrado com este e-mail"}))}})};d.click(function(){$(this).select()}).keydown(function(e){switch(e.which){case 13:e.preventDefault(),l()}}),s.find("button").click(l),c.find("#t"+w+"-add-buyer").click(function(){d.val(""),s.slideToggle()}),$.getJSON("json/misc/config_lists.json",function(e){for(var t=["status","financial_status/current","fulfillment_status/current"],n=0;n<t.length;n++){var a=t[n],i=a.replace("/","."),o=[],r=e.orders[a].enum;for(var s in r)r.hasOwnProperty(s)&&o.push($("<option>",{value:s,text:s,"data-content":'<span class="text-'+r[s].class+'">'+y(r[s].text)+"</span>"}));"status"!==a&&o.unshift('<option value="" selected > -- </option>');var d=c.find('select[name="'+i+'"]');d.html(o);var l=getFromDotNotation(k(),i);l&&d.val(l),d.selectpicker("refresh")}});var u,f,h,p,v,_=function(e,t,n){var a=t._id;e.find("input,select,textarea").data("object-id",a),setupInputValues(e,t,n+".")},b=$("#t"+w+"-order-payment");u=b,f="transactions",p=k(),(v=p[f])&&v.length?(h=v[0],v.length):(h={_id:randomObjectId()},v=p[f]=[h]),_(u,h,f),b.find("#t"+w+"-payment-method-code").change(function(){var e=$(this).find("[selected]").data("content");if(e){var t=$(this).data("object-id"),n=$(e).children('[data-lang="'+g+'"]').text();if(n)for(var a=k(),i=0;i<a.transactions.length;i++){var o=a.transactions[i];if(o._id===t){o.payment_method.name=n,x(a,!0);break}}}})};e.$form?t():$(document).one("form-"+w,t)}();