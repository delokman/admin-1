!function(){"use strict";var v=window.lang,g=window.i18n,b=window.tabId,e=window.Tabs[b],_=e.commit,y=function(){return e.data},t=function(){var t=y(),c=$("#t"+b+"-order-base"),e=c.find("#t"+b+"-order-amount"),n=e.find('input[name="amount.total"]');e.find('input:not([name="amount.total"])').change(function(){setTimeout(function(){var e=y().amount,t=(e.subtotal||0)+(e.freight||0)-(e.discount||0);e.tax&&(t+=e.tax),e.extra&&(t+=e.extra),n.val(formatMoney(0<=t?t:0)).trigger("change")},150)});var a,u,i=e.find("#t"+b+"-extra-amount"),r=function(){i.children("div").slideToggle()};i.children("a").click(r),t.amount&&(t.amount.tax||t.amount.extra)&&r(),setTimeout(function(){if(a=c.find("#t"+b+"-order-buyers"),u=a.find("#t"+b+"-buyer-info"),t.buyers)for(var e=0;e<t.buyers.length;e++)s(t.buyers[e])},200);var s=function(e){var t,a=e._id,n="",i=e.main_email;if(i&&(n+='<a href="mailto:'+i+'" target="_blank">'+i+"</a>"),e.name?(t=e.name.given_name,e.name.middle_name&&(t+=" "+e.name.middle_name),e.name.family_name&&(t+=" "+e.name.family_name),e.display_name&&(t+=" ("+e.display_name+")")):e.display_name&&(t=e.display_name),t&&(n+="<br>"+t),e.phones){e.phones.length&&(n+="<br>");for(var r=0;r<e.phones.length;r++){0<r&&(n+=" / ");var s=formatPhone(e.phones[r]);n+='<a class="text-muted" href="tel:'+s.replace(/\D/g,"")+'" target="_blank">'+s+"</a>"}}var o=$("<a>",{href:"#/resources/customers/"+a,html:'<i class="fa fa-pencil"></i> '+g({en_us:"edit registration",pt_br:"editar cadastro"})}),d=$("<i>",{class:"p-10 remove fa fa-trash"}).click(function(){for(var e=y(),t=e.buyers,n=0;n<t.length;n++){if(t[n]._id===a){t.splice(n,1),_(e,!0);break}}l.slideUp(300,function(){$(this).remove()})}),l=$("<div>",{class:"hidden mb-3 nested-block",html:[d,"<div>"+n+"</div>",o]});u.append(l),l.slideDown()},o=c.find("#t"+b+"-new-buyer"),d=o.find("input"),l=[],f=function(){o.addClass("ajax");var e="customers.json?main_email="+encodeURIComponent(d.val().trim());e+="&fields=_id,main_email,name,display_name,phones,addresses",window.callApi(e,"GET",function(e,t){if(o.removeClass("ajax"),!e){var n=t.result[0];if(n){var a=y();a.buyers||(a.buyers=[]);for(var i=a.buyers,r=0;r<i.length;r++)if(i[r]._id===n._id)return void app.toast(g({en_us:"This customer has already been added",pt_br:"Este cliente jÃ¡ foi adicionado"}));!l.length&&n.addresses&&(l=n.addresses),delete n.addresses,i.push(n),_(a,!0),s(n)}else app.toast(g({en_us:"No customers found with this email",pt_br:"Nenhum cliente encontrado com este e-mail"}))}})};if(d.click(function(){$(this).select()}).keydown(function(e){switch(e.which){case 13:e.preventDefault(),f()}}),o.find("button").click(f),c.find("#t"+b+"-add-buyer").click(function(){o.slideToggle().find("input"),d.val("").focus()}),t.buyers&&t.buyers.length){var m="customers/"+t.buyers[0]._id+".json";window.callApi(m,"GET",function(e,t){e||(l=t.addresses||[])},null,!0)}$.getJSON("json/misc/config_lists.json",function(e){for(var t=["status","financial_status/current","fulfillment_status/current"],n=0;n<t.length;n++){var a=t[n],i=a.replace("/","."),r=[],s=e.orders[a].enum;for(var o in s)s.hasOwnProperty(o)&&r.push($("<option>",{value:o,text:o,"data-content":'<span class="text-'+s[o].class+'">'+g(s[o].text)+"</span>"}));"status"!==a&&r.unshift('<option value="" selected > -- </option>');var d=c.find('select[name="'+i+'"]');d.html(r);var l=getFromDotNotation(y(),i);l&&d.val(l),d.selectpicker("refresh")}});var p=function(r,e,n,a,s,i){var o,d=!0,l=function(e){var t,n,a,i;e&&e.length&&(("number"!=typeof o||o<0||e.length<=o)&&(o=0),t=r,n=e[o],a=s,i=n._id,t.find("input,select,textarea").data("object-id",i).val(""),setupInputValues(t,n,a+"."),t.find("select").selectpicker("refresh"))},c=function(e){var t;e||(e=y()[s]),(t=e)&&t.length?d&&(r.slideDown().prev().slideUp(),d=!1):d||(r.slideUp().prev().slideDown(),d=!0),l(e),function(e){if(e&&e.length){if(n.removeAttr("disabled"),1<e.length)return a.removeAttr("disabled")}else n.attr("disabled",!0);a.attr("disabled",!0)}(e)};c();e.click(function(){var e=y();e[s]||(e[s]=[]);var t=e[s],n={_id:randomObjectId()};"function"==typeof i&&i(n),t.push(n),o=t.length-1,r.find("input[data-name]").each(function(){$(this).attr("name",$(this).data("name"))}),c(t),r.find("input[required]").first().focus(),_(e,!0)}),r.prev().find("a").click(function(){e.click()}),n.click(function(){var e=y(),t=e[s];t.splice(o,1),c(t),_(e,!0)}),a.click(function(){o++,c()})},h=$("#t"+b+"-order-payment");p(h,$("#t"+b+"-add-transaction"),$("#t"+b+"-delete-transaction"),$("#t"+b+"-next-transaction"),"transactions"),h.find("#t"+b+"-payment-method-code").change(function(){var e=$(this).find("[selected]").data("content");if(e){var t=$(this).data("object-id"),n=$(e).children('[data-lang="'+v+'"]').text();if(n)for(var a=y(),i=0;i<a.transactions.length;i++){var r=a.transactions[i];if(r._id===t){r.payment_method.name=n,_(a,!0);break}}}});p($("#t"+b+"-order-shipping"),$("#t"+b+"-add-shipping"),$("#t"+b+"-delete-shipping"),$("#t"+b+"-next-shipping"),"shipping_lines",function(e){var t;if(e.from={zip:"00000000"},l.length){for(var n=0;n<l.length;n++)if(l[n].default){t=l[n];break}t||(t=l[0])}e.to=Object.assign({zip:"00000000"},t),delete e.to.default,delete e.to._id}),$("div[data-link-collapse]").each(function(){var e=$(this),n=e.children("div"),a=e.children("em"),t=function(){var t="";n.find("input").each(function(){var e=$(this).val();("string"==typeof e&&""!==e.trim()||"number"==typeof e)&&(t+=e+", ")}),a.text(t.slice(0,-2))};e.children("a").click(function(){n.slideToggle("slow"),t(),a.slideToggle()}),t()})};e.$form?t():$(document).one("form-"+b,t)}();